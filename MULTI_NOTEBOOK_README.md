# 多笔记本RAG系统说明

## 概述

修改后的思源笔记RAG系统现在支持多笔记本功能，知识库可以同时包含多个笔记本的内容，避免了之前的覆盖重建问题。

## 主要修改

### 1. RAG知识库增强 (`utils/rag/rag_knowledge_base.py`)

#### 新增功能：
- **智能检测机制**: 自动检查笔记本是否已存在于知识库中
- **累积构建**: 支持向现有知识库添加新笔记本内容，而不覆盖现有数据
- **强制重建选项**: 提供 `force_rebuild` 参数，可强制重建特定笔记本
- **统计信息**: 新增方法获取所有笔记本的统计信息

#### 新增方法：
```python
async def get_notebook_document_count(self, notebook_id: str) -> int:
    """获取指定笔记本的文档数量"""

async def get_all_notebooks_stats(self) -> Dict[str, int]:
    """获取所有笔记本的统计信息"""
```

#### 修改的方法：
```python
async def build_knowledge_base(self,
                              notebook_id: str,
                              force_rebuild: bool = False,  # 新增参数
                              **kwargs) -> int:
```

### 2. 交互式系统增强 (`main.py`)

#### 新增功能：
- **多笔记本支持**: 用户可以选择多个笔记本并累积构建知识库
- **智能跳过**: 如果笔记本已存在，自动跳过构建过程
- **统计显示**: 显示所有笔记本的详细统计信息
- **新增命令**: 添加了 `/notebooks` 命令查看所有笔记本状态

#### 新增命令：
- `/notebooks`: 显示所有笔记本的统计信息
- `/rebuild`: 强制重建当前笔记本（需要确认）

#### 修改的逻辑：
- 构建知识库时会先检查笔记本是否已存在
- 如果已存在且不强制重建，则跳过构建
- 显示所有笔记本的统计信息，不仅仅是当前笔记本

### 3. 演示脚本 (`demo_multi_notebook.py`)

创建了一个新的演示脚本，展示：
- 如何批量添加多个笔记本到知识库
- 跨笔记本查询功能
- 多笔记本统计信息显示

## 使用方法

### 基本使用

1. **启动交互式系统**:
   ```bash
   python main.py
   ```

2. **选择笔记本并构建**:
   - 系统会显示可用笔记本列表
   - 选择笔记本后自动构建知识库
   - 如果笔记本已存在，会自动跳过

3. **查看统计信息**:
   ```
   /stats      # 显示详细统计信息
   /notebooks  # 显示所有笔记本状态
   ```

4. **查询**:
   - 直接输入问题进行查询
   - 默认在所有笔记本中搜索
   - Agent会自动从相关笔记本中获取信息

### 高级功能

1. **强制重建笔记本**:
   ```
   /rebuild
   ```
   系统会要求确认，然后重建当前笔记本的知识库

2. **切换笔记本**:
   ```
   /notebook
   ```
   选择新的笔记本进行查询

3. **跨笔记本查询**:
   系统会自动在所有已构建的笔记本中搜索相关内容

## 技术细节

### 数据存储
- 所有笔记本的数据存储在同一个ChromaDB集合中
- 每个文档块都包含 `notebook_id` 元数据，用于标识来源笔记本
- 支持按笔记本ID过滤和统计

### 构建策略
- **增量构建**: 新笔记本会添加到现有知识库
- **智能跳过**: 已存在的笔记本不会重复构建
- **强制重建**: 可以选择性地重建特定笔记本

### 查询优化
- 支持指定笔记本ID进行精确查询
- 也支持跨笔记本的全局搜索
- 自动显示来源笔记本信息

## 优势

1. **避免重复处理**: 已存在的笔记本不会重复构建
2. **知识库整合**: 多个笔记本内容统一管理
3. **灵活查询**: 支持单笔记本精确查询和多笔记本全局搜索
4. **统计透明**: 清晰显示每个笔记本的数据量
5. **易于扩展**: 可以轻松添加新笔记本到现有知识库

## 注意事项

1. **存储空间**: 多个笔记本会增加向量数据库的存储需求
2. **查询性能**: 大量数据可能影响查询速度，建议定期评估
3. **内存使用**: 嵌入模型需要足够的内存支持
4. **数据一致性**: 强制重建时请注意数据丢失风险

## 示例输出

```
📚 知识库中的笔记本:
------------------------------------------------------------
  📖 日记 (202306021434...): 1,234 个文档块
  📖 数码电子 (202306011551...): 2,567 个文档块
  📖 编程学习 (202406161525...): 5,890 个文档块
------------------------------------------------------------
```

这样的设计使得RAG系统更加实用和高效，用户可以逐步构建包含多个笔记本的知识库，而不需要每次都重新处理所有数据。